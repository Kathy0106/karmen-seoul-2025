<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦–çˆ¾è–èª•æ—…è¡Œ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Zen Maru Gothic (æ¸…æ¥šæ˜“è®€çš„æ—¥ç³»å­—é«”) -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons (å¯æ„›é¢¨æ ¼åœ–æ¨™) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDK (å¿…é ˆè¼‰å…¥) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firebase æ—¥èªŒç´šåˆ¥
        setLogLevel('debug');

        // å…¨åŸŸè®Šæ•¸æª¢æŸ¥ (ç”± Canvas ç’°å¢ƒæä¾›)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let userId = 'local-user'; // é è¨­ä½¿ç”¨ local-user ID
        let isAuthReady = false;

        // æ¨¡æ“¬çš„ Naver Map é€£çµå‡½æ•¸
        window.getNaverMapUrl = (address) => {
            const baseUrl = 'https://map.naver.com/v5/search/';
            return baseUrl + encodeURIComponent(address);
        };
        
        // ----------------------------------------------------
        // IMPORTANT: å°‡ loadTripData æå‡åˆ° window ä½œç”¨åŸŸï¼Œä¸¦ç¢ºä¿å®ƒèƒ½ç²å– db/auth/userId
        // ----------------------------------------------------
        window.initFirebase = async () => {
            try {
                if (!firebaseConfig) {
                    console.warn("Firebase config is missing. App will only use default local data.");
                    isAuthReady = true;
                    // å¦‚æœæ²’æœ‰ configï¼Œç›´æ¥è¿”å›ï¼ŒApp æœƒä¿æŒé¡¯ç¤ºé è¨­æ•¸æ“š
                    return;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // å˜—è©¦ä½¿ç”¨æä¾›çš„ token ç™»å…¥ï¼Œå¦å‰‡åŒ¿åç™»å…¥
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // ç›£è½é©—è­‰ç‹€æ…‹è®ŠåŒ– (é€™æœƒç¢ºä¿ Firebase é€£ç·šå’Œèªè­‰å®Œæˆå¾Œæ‰è¼‰å…¥æ•¸æ“š)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth Ready. User ID:", userId);
                    } else {
                        // åŒ¿åç™»å…¥å¤±æ•—æˆ–ç™»å‡ºï¼Œä½¿ç”¨éš¨æ©Ÿ ID ä½œç‚ºå‡ UID (å¦‚æœå‰é¢åŒ¿åç™»å…¥æˆåŠŸå‰‡ä¸æœƒåŸ·è¡Œé€™è£¡)
                        userId = crypto.randomUUID();
                    }
                    isAuthReady = true;
                    
                    // åªæœ‰åœ¨ auth ready ä¸” db å­˜åœ¨æ™‚æ‰å˜—è©¦è¼‰å…¥çœŸå¯¦æ•¸æ“š
                    if (db) {
                        window.db = db;
                        window.auth = auth;
                        window.userId = userId;
                        window.appId = appId;
                        window.loadTripData(false); 
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œæ¨™è¨˜ auth ready (ä½† db ä»ç‚º null)ï¼ŒApp æœƒç¹¼çºŒä½¿ç”¨é è¨­æ•¸æ“š
                isAuthReady = true;
            }
        };

        // åœ¨ window.onload ä¹‹å¾Œæ‰‹å‹•èª¿ç”¨ initFirebase
        window.initFirebase();
    </script>

    <script>
        // --- æ¨£å¼è¨­å®šèˆ‡ Tailwind é…ç½® ---
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fuji-blue': '#6a82b3', // ä¸»è‰²ï¼šå¯Œå£«è—
                        'snow-white': '#ffffff', // é›ªç™½
                        'warm-gray': '#f5f5f5', // æš–ç° (èƒŒæ™¯è‰²)
                        'accent-red': '#D9534F',
                        'accent-green': '#5CB85C',
                        'accent-yellow': '#F0AD4E',
                    },
                    fontFamily: {
                        sans: ['"Zen Maru Gothic"', 'sans-serif'],
                    },
                }
            }
        }

        // --- é è¨­è¡Œç¨‹æ•¸æ“š (å·²å°‡æ•¸æ“šå¾åº•éƒ¨ç§»å‹•åˆ°é ‚éƒ¨ï¼Œç¢ºä¿åŒæ­¥å¯ç”¨) ---
        const initialItinerary = [
            { date: "12/25", dayName: "Day 1", mainArea: "å®‰åœ‹, å¼˜å¤§, å»¶å—æ´, æ˜æ´", weather: "8Â°C, æ™´ (APIè¼‰å…¥ä¸­)",
                dressCode: "å»ºè­°: æ¥µåšå¤–å¥—ã€åœå·¾ã€æ‰‹å¥— (Heavy coat, scarf, gloves). é›ªæ³: ç„¡ç©é›ª (No snow).",
                events: [
                    { time: "08:00", category: "é£Ÿç‰©", name: "Dotori Garden (ë„í† ë¦¬ê°€ë“ )", address: "ì„œìš¸ ì¢…ë¡œêµ¬ ë¶ì´Œë¡œ 4ê¸¸ 20", notes: "å¿…åƒï¼šæ‹›ç‰Œç‰›è§’åŒ…", tags: ["å¿…åƒ"], naverId: "12345" },
                    { time: "10:30", category: "è³¼ç‰©", name: "ZERO SPACEï¼ˆì œë¡œìŠ¤í˜ì´ìŠ¤ï¼‰", address: "ì„œìš¸ ì¢…ë¡œêµ¬ ë¶ì´Œë¡œ5ê°€ê¸¸ 16", notes: "å®‰åœ‹é€›è¡—é †è·¯", tags: ["å¿…è²·"], naverId: "12346" },
                    { time: "12:30", category: "äº¤é€š", name: "å®‰åœ‹ â†’ å¼˜å¤§", address: "åœ°éµ", notes: "åœ°éµ18åˆ†é˜", tags: [], naverId: "" },
                    { time: "13:00", category: "é£Ÿç‰©", name: "Gop Mapo çƒ¤è‚¥è…¸ (ê³±ë§ˆí¬)", address: "ì„œìš¸ ë§ˆí¬êµ¬ ë…ë§‰ë¡œ7ê¸¸ 51", notes: "åˆé¤", tags: ["å¿…åƒ"], naverId: "12347" },
                    { time: "15:00", category: "é£Ÿç‰©", name: "Artist Bakery å¼˜å¤§ (ì•„í‹°ìŠ¤íŠ¸ ë² ì´ì»¤ë¦¬)", address: "ì„œìš¸ ë§ˆí¬êµ¬ ë™êµë¡œ 251-3", notes: "ä¸‹åˆèŒ¶ï¼Œå¿…æ‹å¯é Œ", tags: ["å¿…æ‹"], naverId: "12348" },
                    { time: "17:00", category: "æ™¯é»", name: "å»¶å—æ´", address: "å¼˜å¤§æ—", notes: "æ•£æ­¥ã€å°åº—ã€ç”œé¤…", tags: [], naverId: "" },
                    { time: "19:30", category: "é£Ÿç‰©", name: "ğŸ¦€çƒé”é‡Œå®¶ï¼ˆé†¬èŸ¹ï¼‰(ì˜¤ë‹¤ë¦¬ì§‘ ê°„ì¥ê²Œì¥)", address: "ì„œìš¸ ì¤‘êµ¬ ëª…ë™8ë‚˜ê¸¸ 28 2â€“3ì¸µ", notes: "æ™šé¤ï¼Œé†¬èŸ¹å®šé£Ÿ", tags: ["å¿…åƒ"], naverId: "12349" },
                    { time: "21:00", category: "æ™¯é»", name: "æ˜æ´è–èª•ç‡ˆé£¾ï¼ˆæ˜æ´è–å ‚ï¼‰", address: "ì„œìš¸ ì¤‘êµ¬ ëª…ë™ê¸¸ 74", notes: "å¿…æ‹ç‡ˆé£¾ï¼", photoTip: "ä½¿ç”¨äººåƒæ¨¡å¼æ‹æ”ï¼ŒèƒŒæ™¯è™›åŒ–æ›´å¤¢å¹»ã€‚", tags: ["å¿…æ‹"], naverId: "12350" },
                ]
            },
            { date: "12/26", dayName: "Day 2", mainArea: "æ˜æ´, å—å¤§é–€, æ±å¤§é–€, æ–°å ‚", weather: "5Â°C, é™° (APIè¼‰å…¥ä¸­)",
                dressCode: "å»ºè­°: ä¿æš–å…§è¡£ã€æ¯›è¡£ (Thermal, sweater). é›ªæ³: ä½æº«ä¹¾ç‡¥ (Cold & Dry).",
                events: [
                    { time: "09:00", category: "é£Ÿç‰©", name: "å®‹å®¶é£¯æ²ï¼ˆæ˜æ´ï¼‰(ì†¡ê°€ê¹€ë°¥)", address: "ì„œìš¸ ì¤‘êµ¬ í‡´ê³„ë¡œ 120", notes: "æ—©é¤", tags: ["å¿…åƒ"], naverId: "22345" },
                    { time: "11:00", category: "è³¼ç‰©", name: "æ˜æ´è³¼ç‰©å€ (ëª…ë™ê±°ë¦¬)", address: "ì„œìš¸ ì¤‘êµ¬ ëª…ë™ê¸¸ ì¼ëŒ€", notes: "æƒè²¨æ™‚é–“", tags: ["å¿…è²·"], naverId: "22346" },
                    { time: "13:00", category: "é£Ÿç‰©", name: "éŸ“ç‰›ä¸€æ¢è¡—ï¼ˆé€€æºªè·¯ï¼‰(í‡´ê³„ë¡œ í•œìš°ê³¨ëª©)", address: "ì„œìš¸ ì¤‘êµ¬ í‡´ê³„ë¡œ 180ê¸¸ ì¼ëŒ€", notes: "åˆé¤", tags: ["å¿…åƒ"], naverId: "22347" },
                    { time: "15:00", category: "è³¼ç‰©", name: "å—å¤§é–€å¸‚å ´ (ë‚¨ëŒ€ë¬¸ì‹œì¥)", address: "ì„œìš¸ ì¤‘êµ¬ ë‚¨ëŒ€ë¬¸ì‹œì¥4ê¸¸ 21", notes: "é›¶é£Ÿã€æ‰‹ä¿¡", tags: ["å¿…è²·"], naverId: "22348" },
                    { time: "17:00", category: "è³¼ç‰©", name: "Doota Mall (ë‘íƒ€ëª°)", address: "ì„œìš¸ ì¤‘êµ¬ ì¥ì¶©ë‹¨ë¡œ 275", notes: "No Brand æƒè²¨", tags: ["å¿…è²·"], naverId: "22349" },
                    { time: "18:00", category: "ç”œå“", name: "Scooper Gelato", address: "ë‘íƒ€ëª° åœ°ä¸‹å±¤", notes: "é–‹å¿ƒæœ AFFOGATO", tags: ["å¿…åƒ"], naverId: "22350" },
                    { time: "20:00", category: "é£Ÿç‰©", name: "å‹èª¼è¾£é›çˆª (ìš°ì •ë‹­ë°œ)", address: "ì„œìš¸ ì¤‘êµ¬ í‡´ê³„ë¡œ 421", notes: "æ™šé¤ï¼Œæ–°å ‚ ë‹­ë°œ ê³¨ëª©", tags: ["å¿…åƒ"], naverId: "22351" },
                ]
            },
            { date: "12/27", dayName: "Day 3", mainArea: "å®‰åœ‹ CafÃ©, ç›Šå–„æ´, ä¹™æ”¯è·¯", weather: "10Â°C, å¤šé›² (APIè¼‰å…¥ä¸­)",
                dressCode: "å»ºè­°: å¤šå±¤æ¬¡ç©¿æ­ï¼Œå®¤å…§æœƒå¾ˆæš– (Layers). é›ªæ³: ç„¡ (None).",
                events: [
                    { time: "09:30", category: "é£Ÿç‰©", name: "Cafe Layered (å®‰åœ‹) (ì¹´í˜ ë ˆì´ì–´ë“œ)", address: "ì„œìš¸ ì¢…ë¡œêµ¬ ë¶ì´Œë¡œ 6", notes: "æ—©é¤ï¼Œæ‰“å¡å’–å•¡å»³", tags: ["å¿…æ‹"], naverId: "32345" },
                    { time: "13:00", category: "é£Ÿç‰©", name: "Nakwonjangï¼ˆç›Šå–„æ´ï¼‰(ë‚™ì›ì¥)", address: "ì„œìš¸ ì¢…ë¡œêµ¬ ìˆ˜í‘œë¡œ28ê¸¸ 33", notes: "åˆé¤", tags: ["å¿…åƒ"], naverId: "32346" },
                    { time: "15:00", category: "æ™¯é»", name: "ç›Šå–„æ´éŸ“å±‹è¡—", address: "ì„œìš¸ ì¢…ë¡œêµ¬ ìˆ˜í‘œë¡œ28ê¸¸ ì¼ëŒ€", notes: "è¡Œå°åº—ï¼æ‰“å¡", tags: ["å¿…æ‹"], naverId: "32347" },
                    { time: "19:00", category: "é£Ÿç‰©", name: "æ°´èŠ¹èœçƒ¤è±¬è‚‰ (ëŒíŒ ìˆ˜ë¯¸ë‚˜ë¬¼ ì‚¼ê²¹ì‚´)", address: "ì„œìš¸ ì¤‘êµ¬ ìˆ˜í‘œë¡œ 48-1", notes: "æ™šé¤ï¼Œä¹™æ”¯è·¯", tags: ["å¿…åƒ"], naverId: "32348" },
                    { time: "21:00", category: "æ´»å‹•", name: "é£¯å¾Œè‡ªç”±æ´»å‹•", address: "", notes: "å›é…’åº— / ä¾¿åˆ©åº— / æ˜æ´æ•£æ­¥ çš†å¯", tags: [], naverId: "" },
                ]
            },
            { date: "12/28", dayName: "Day 4", mainArea: "è–æ°´ ALL DAY, æ˜æ´", weather: "3Â°C, é›ª (APIè¼‰å…¥ä¸­)",
                dressCode: "å»ºè­°: é˜²æ°´é´ã€å¸½å­ (Waterproof boots, hat). é›ªæ³: æœ‰æ©Ÿæœƒä¸‹é›ªï¼(Chance of snow!).",
                events: [
                    { time: "08:30", category: "é£Ÿç‰©", name: "Onion è–æ°´ (ì–´ë‹ˆì–¸ ì„±ìˆ˜)", address: "ì„œìš¸ ì„±ë™êµ¬ ì•„ì°¨ì‚°ë¡œ17ê¸¸ 33", notes: "æ—©é¤ï¼Œæ‰“å¡å’–å•¡å»³", tags: ["å¿…æ‹"], naverId: "42345" },
                    { time: "10:30", category: "è³¼ç‰©", name: "è–æ°´æ½®æµæ•£æ­¥", address: "è–æ°´æ´ä¸€å¸¶", notes: "Musinsa, ADER ERROR, Tamburins", tags: ["å¿…è²·"], naverId: "42346" },
                    { time: "13:00", category: "é£Ÿç‰©", name: "ç„¡å¢å±‹ (ë¬´ì¿ ìš°ë™)", address: "ì„œìš¸ ì„±ë™êµ¬ ì„œìš¸ìˆ²2ê¸¸ 28-13", notes: "åˆé¤ï¼Œçƒå†¬", tags: ["å¿…åƒ"], naverId: "42347" },
                    { time: "15:00", category: "ç”œå“", name: "Milky Shop (ë°€í‚¤ìƒµ)", address: "ì„œìš¸ ì„±ë™êµ¬ ì„œìš¸ìˆ²2ê¸¸ 19-13", notes: "ç”œå“æ™‚é–“", tags: ["å¿…åƒ", "å¿…æ‹"], naverId: "42348" },
                    { time: "17:00", category: "äº¤é€š", name: "è–æ°´ â†’ æ˜æ´", address: "åœ°éµ", notes: "20â€“25åˆ†é˜", tags: [], naverId: "" },
                    { time: "19:00", category: "é£Ÿç‰©", name: "æ™šé¤ (äºŒé¸ä¸€)", address: "", notes: "IDAEJO æ’éª¨æ¹¯ æˆ– æ˜æ´ç‚¸é›", tags: ["å¿…åƒ"], naverId: "" },
                ]
            },
            { date: "12/29", dayName: "Day 5", mainArea: "æœ€å¾Œè£œè²¨, é°»é­š, æ©Ÿå ´", weather: "6Â°C, æ™´ (APIè¼‰å…¥ä¸­)",
                dressCode: "å»ºè­°: è¼•ä¾¿è£æŸï¼Œæ–¹ä¾¿ç§»å‹• (Comfortable for travel). é›ªæ³: ç„¡ (None).",
                events: [
                    { time: "09:00", category: "é£Ÿç‰©", name: "Egg Drop (æ˜æ´) (ì—ê·¸ë“œë)", address: "ì„œìš¸ ì¤‘êµ¬ ëª…ë™ê¸¸ 24", notes: "æ—©é¤", tags: ["å¿…åƒ"], naverId: "52345" },
                    { time: "10:30", category: "è³¼ç‰©", name: "æ˜æ´æœ€å¾Œæƒè²¨", address: "ì„œìš¸ ì¤‘êµ¬ ëª…ë™ê¸¸ ì¼ëŒ€", notes: "æ‰‹ä¿¡ã€é›¶é£Ÿè£œè²¨", tags: ["å¿…è²·"], naverId: "52346" },
                    { time: "13:00", category: "é£Ÿç‰©", name: "æœ€å¾Œåˆé¤ï¼šè±å·é°»é­š (í’ì²œì¥ì–´)", address: "ì„œìš¸ ì¤‘êµ¬ ëª…ë™4ê¸¸ 10", notes: "æ»‹è£œä¸€ä¸‹", tags: ["å¿…åƒ"], naverId: "52347" },
                    { time: "15:00", category: "äº¤é€š", name: "å›é…’åº—æ‹è¡Œæ â†’ æ©Ÿå ´", address: "", notes: "é ç•™å……è¶³æ™‚é–“", tags: [], naverId: "" },
                ]
            }
        ];

        // é è¨­çš„æ—…è¡Œæ•¸æ“šçµæ§‹ (å·²æ›´æ–°åç¨±)
        const defaultTripData = {
            tripName: "é¦–çˆ¾è–èª•æ—…è¡Œ",
            dates: "2025/12/25 - 2025/12/29", // YYYY/MM/DD - YYYY/MM/DD
            flights: {
                outbound: { flight: "UO626", from: "é¦™æ¸¯ (HKG)", to: "é¦–çˆ¾ (ICN)", status: "æº–æ™‚", departure: "12/25 10:00", arrival: "12:30" },
                inbound: { flight: "UO631", from: "é¦–çˆ¾ (ICN)", to: "é¦™æ¸¯ (HKG)", status: "æº–æ™‚", departure: "12/29 18:00", arrival: "21:00" },
            },
            budget: {
                baseCurrency: "HKD",
                targetCurrency: "KRW",
                totalBudget: 5000,
                daily: initialItinerary.map(day => ({
                    date: day.date, // MM/DD
                    budget: 1000,
                    spent: 0,
                    expenses: []
                }))
            },
            itinerary: initialItinerary,
        };

        // --- å…¨åŸŸæ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ ---
        let state = {
            currentTab: 'itinerary', // itinerary | guide | budget
            currentDayIndex: 0,
            tripData: defaultTripData, // *** ç«‹å³è¨­å®šé è¨­æ•¸æ“š ***
            exchangeRate: { rate: 0.0, source: 'Loading...' },
            exchangeAttempts: 0
        };

        // æ™¯é»åˆ†é¡å°æ‡‰çš„åœ–æ¨™
        const categoryIcons = {
            'é£Ÿç‰©': 'utensils',
            'æ´»å‹•': 'party-popper',
            'è³¼ç‰©': 'shopping-bag',
            'æ™¯é»': 'map-pin',
            'é…’åº—': 'bed',
            'äº¤é€š': 'car',
            'ç”œå“': 'ice-cream'
        };
        
        // --- Firebase Firestore æ•¸æ“šè™•ç† ---
        const TRIP_DOC_PATH = (uid) => `artifacts/${appId}/users/${uid}/seoul_trip_planner/trip_data`;

        window.loadTripData = async (forceDefault = false) => {
             // å¦‚æœæ²’æœ‰æˆåŠŸé€£æ¥åˆ° Firebase (db ç‚º null)ï¼Œå‰‡ä¸åŸ·è¡Œå¾ŒçºŒçš„ Firestore è®€å–æ“ä½œã€‚
            if (!window.db) {
                console.log("Firestore not available. Using existing state data.");
                fetchExchangeRate(); 
                return;
            }

            console.log("Attempting to load data for user:", window.userId);

            const docRef = doc(window.db, TRIP_DOC_PATH(window.userId));

            // ä½¿ç”¨ onSnapshot å¯¦ç¾å¯¦æ™‚æ›´æ–°
            onSnapshot(docRef, (docSnap) => {
                let data = defaultTripData;
                if (docSnap.exists()) {
                    console.log("Document data found:", docSnap.data());
                    data = docSnap.data();
                    // ç¢ºä¿èˆŠæ•¸æ“šçµæ§‹å…¼å®¹ (ç°¡åŒ–è™•ç†ï¼Œå¯¦éš›å¯èƒ½éœ€è¦æ›´è¤‡é›œçš„é·ç§»)
                    if (!data.itinerary || data.itinerary.length === 0) {
                        data.itinerary = defaultTripData.itinerary;
                    }
                    if (!data.budget || !data.budget.daily || data.budget.daily.length === 0) {
                         data.budget = defaultTripData.budget;
                    }
                } else {
                    console.log("No document found, setting initial data.");
                    setDoc(docRef, defaultTripData).catch(e => console.error("Error setting initial document:", e));
                }

                state.tripData = data;
                // ç¢ºä¿åˆ‡æ›åˆ°æ–°å¢çš„ Day (å¦‚æœæ•¸æ“šé‡æ”¹è®Šä¸”ç•¶å‰ Day è¶…å‡ºç¯„åœ)
                if (state.currentDayIndex >= data.itinerary.length) {
                    state.currentDayIndex = data.itinerary.length - 1;
                }
                renderApp(); // å¾ Firestore ç²å–æ•¸æ“šå¾Œé‡æ–°æ¸²æŸ“
                fetchExchangeRate(); // è¼‰å…¥è³‡æ–™å¾Œç²å–åŒ¯ç‡
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                // æ•¸æ“šåº«é€£ç·šæˆ–æ¬Šé™éŒ¯èª¤æ™‚ï¼Œç¶­æŒç¾æœ‰ state (å³é è¨­æ•¸æ“š)
                renderApp(); 
                fetchExchangeRate();
            });
        };


        window.saveTripData = async (newData) => {
            if (!window.db || !window.userId) {
                console.error("Cannot save: Firestore or User ID not available. Data saved locally only.");
                state.tripData = newData; // åƒ…æ›´æ–°æœ¬åœ°ç‹€æ…‹
                renderApp();
                return;
            }
            try {
                const docRef = doc(window.db, TRIP_DOC_PATH(window.userId));
                await setDoc(docRef, newData, { merge: true }); // ä½¿ç”¨ merge ä»¥å…è¦†è“‹æ•´å€‹æ–‡æª”
                console.log("Trip data saved successfully.");
                // onSnapshot æœƒè‡ªå‹•æ›´æ–° state.tripData å’Œ UI
            } catch (error) {
                console.error("Error saving trip data:", error);
            }
        };

        // --- è¡Œç¨‹æ—¥æœŸè™•ç†å‡½æ•¸ ---

        /**
         * å°‡ MM/DD æ ¼å¼çš„æ—¥æœŸå’Œ YYYY å¹´ä»½çµ„åˆç‚º DD/MM/YYYY æ ¼å¼ç”¨æ–¼é¡¯ç¤ºã€‚
         * @param {string} dateMMDD - MM/DD æ ¼å¼çš„æ—¥æœŸ (e.g., "12/25")
         * @param {string} tripYear - YYYY æ ¼å¼çš„å¹´ä»½ (e.g., "2025")
         * @returns {string} DD/MM/YYYY æ ¼å¼çš„æ—¥æœŸ (e.g., "25/12/2025")
         */
        function formatDateToDisplay(dateMMDD, tripYear) {
            const [month, dayNum] = dateMMDD.split('/');
            return `${dayNum}/${month}/${tripYear}`;
        };

        /**
         * è¨ˆç®—ä¸‹ä¸€å¤©çš„æ—¥æœŸã€‚
         * @param {string} lastDateMMDD - ä¸Šä¸€å€‹æ—¥å­çš„ MM/DD æ ¼å¼æ—¥æœŸ (e.g., "12/31")
         * @param {string} tripYear - YYYY æ ¼å¼çš„å¹´ä»½ (e.g., "2025")
         * @returns {string} ä¸‹ä¸€å€‹æ—¥å­çš„ MM/DD æ ¼å¼æ—¥æœŸ (e.g., "01/01")
         */
        function calculateNextDate(lastDateMMDD, tripYear) {
            const [month, day] = lastDateMMDD.split('/').map(Number);
            // æ³¨æ„ï¼šæœˆä»½åœ¨ Date ç‰©ä»¶ä¸­æ˜¯ 0-indexed (12æœˆæ˜¯ 11)
            const lastDate = new Date(Number(tripYear), month - 1, day); 
            lastDate.setDate(lastDate.getDate() + 1); // åŠ ä¸€å¤©

            // ç²å–æ–°æ—¥æœŸï¼Œä¸¦ç¢ºä¿ MM/DD æ ¼å¼
            const newMonth = (lastDate.getMonth() + 1).toString().padStart(2, '0');
            const newDay = lastDate.getDate().toString().padStart(2, '0');
            
            return `${newMonth}/${newDay}`; // MM/DD
        }

        /**
         * æ–°å¢ä¸€å¤©è¡Œç¨‹ã€‚
         */
        window.addDay = () => {
            const tripData = JSON.parse(JSON.stringify(state.tripData)); // æ·±è¤‡è£½æ•¸æ“š
            const lastDayIndex = tripData.itinerary.length - 1;
            const lastDay = tripData.itinerary[lastDayIndex];
            
            // æå–å¹´ä»½ (å‡è¨­ tripData.dates æ ¼å¼ç‚º "YYYY/MM/DD - YYYY/MM/DD")
            const tripYear = tripData.dates.substring(0, 4);

            // 1. è¨ˆç®—æ–°çš„æ—¥æœŸ (MM/DD)
            const newDateMMDD = calculateNextDate(lastDay.date, tripYear);
            
            // 2. ç¢ºå®šæ–°çš„ Day åç¨±å’Œç´¢å¼•
            const newDayIndex = lastDayIndex + 1;
            const newDayName = `Day ${newDayIndex + 1}`;
            
            // 3. å»ºç«‹æ–°çš„è¡Œç¨‹æ—¥å’Œé ç®—é …ç›®
            const newItineraryDay = {
                date: newDateMMDD, 
                dayName: newDayName, 
                mainArea: "æ–°å¢è¡Œç¨‹ - è«‹ç·¨è¼¯", 
                weather: "è¼‰å…¥ä¸­...",
                dressCode: "å»ºè­°: è«‹è‡ªè¡Œå¡«å¯« (Enter your suggestions). é›ªæ³: N/A.",
                events: [
                    { time: "10:00", category: "æ™¯é»", name: "æ¢ç´¢æ–°å€åŸŸ", address: "", notes: "ç¬¬ä¸€é …è¡Œç¨‹", tags: [], naverId: "" }
                ]
            };
            
            const newBudgetEntry = {
                date: newDateMMDD, // MM/DD
                budget: 1000,
                spent: 0,
                expenses: []
            };

            // 4. æ›´æ–°æ•¸æ“š
            tripData.itinerary.push(newItineraryDay);
            tripData.budget.daily.push(newBudgetEntry);

            // 5. æ›´æ–°ç¸½æ—…è¡Œæ—¥æœŸç¯„åœ (æ›´æ–°çµæŸæ—¥æœŸ)
            // tripData.dates æ ¼å¼: "YYYY/MM/DD - YYYY/MM/DD"
            const datesParts = tripData.dates.split(' - ');
            if (datesParts.length === 2) {
                const newEndYYYYMMDD = `${tripYear}/${newDateMMDD}`; // YYYY/MM/DD
                datesParts[1] = newEndYYYYMMDD;
                tripData.dates = datesParts.join(' - ');
            }

            // 6. å„²å­˜ä¸¦åˆ‡æ›åˆ°æ–°å¢çš„ Day
            window.saveTripData(tripData);
            state.currentDayIndex = newDayIndex; // åˆ‡æ›åˆ°æ–°çš„ Day
            renderApp();
        }

        // --- LLM API å‘¼å«ï¼šç²å–å³æ™‚åŒ¯ç‡ (ä¿æŒä¸è®Š) ---
        async function fetchExchangeRate() {
            if (!state.tripData) return; // ç¢ºä¿æœ‰æ•¸æ“šæ‰åŸ·è¡Œ

            if (state.exchangeAttempts >= 3) {
                state.exchangeRate = { rate: 170.00, source: 'Mock (Failed to fetch)' };
                if (state.currentTab === 'guide') renderApp();
                return;
            }
            state.exchangeAttempts++;
            state.exchangeRate = { rate: 0.0, source: 'Loading...' };
            if (state.currentTab === 'guide') renderApp(); // é‡æ–°æ¸²æŸ“ loading ç‹€æ…‹

            const base = state.tripData.budget.baseCurrency || 'HKD';
            const target = state.tripData.budget.targetCurrency || 'KRW';
            const userQuery = `What is the current exchange rate from ${base} to ${target}? Provide only the rate and the source name.`;
            const apiKey = ""
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: "You are a helpful assistant. Respond concisely with the exchange rate number (e.g., 170.50) and one source title. Use the format: RATE | SOURCE_TITLE" }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || '';
                const parts = text.split('|').map(p => p.trim());
                
                if (parts.length >= 2) {
                    const rate = parseFloat(parts[0]);
                    const source = parts[1];
                    if (!isNaN(rate) && rate > 0) {
                        state.exchangeRate = { rate, source: source.substring(0, 30) + (source.length > 30 ? '...' : '') };
                    } else {
                        throw new Error("Invalid rate format received.");
                    }
                } else {
                    throw new Error("Unexpected API response format.");
                }

            } catch (error) {
                console.error("Error fetching exchange rate:", error);
                // Exponential backoff simulation (simplified)
                await new Promise(resolve => setTimeout(resolve, 1000 * state.exchangeAttempts));
                fetchExchangeRate(); // Retry
            }
            if (state.currentTab === 'guide') renderApp();
        }

        // --- æ‡‰ç”¨ç¨‹å¼æ¸²æŸ“èˆ‡äº’å‹•å‡½æ•¸ (ä¿æŒä¸è®Šï¼Œä½†è«‹æ³¨æ„ renderApp çš„èª¿ç”¨) ---

        function switchTab(tab) {
            state.currentTab = tab;
            renderApp();
            if (tab === 'guide') {
                fetchExchangeRate(); // åˆ‡æ›åˆ° Guide é æ™‚æ‰é‡æ–°ç²å–åŒ¯ç‡
            }
        }
        
        function selectDay(index) {
            state.currentDayIndex = index;
            renderApp();
        }

        function getCategoryStyle(category) {
            switch (category) {
                case 'é£Ÿç‰©': return 'bg-yellow-100 text-yellow-700';
                case 'æ´»å‹•': return 'bg-pink-100 text-pink-700';
                case 'è³¼ç‰©': return 'bg-fuji-blue/20 text-fuji-blue';
                case 'æ™¯é»': return 'bg-green-100 text-green-700';
                case 'é…’åº—': return 'bg-red-100 text-red-700';
                case 'äº¤é€š': return 'bg-gray-200 text-gray-600';
                case 'ç”œå“': return 'bg-purple-100 text-purple-700';
                default: return 'bg-gray-100 text-gray-500';
            }
        }

        function getTagStyle(tag) {
             switch (tag) {
                case 'å¿…åƒ': return 'bg-accent-red text-white';
                case 'å¿…è²·': return 'bg-fuji-blue text-white';
                case 'å¿…æ‹': return 'bg-accent-yellow text-gray-800';
                default: return 'bg-gray-500 text-white';
            }
        }

        function openEditBudgetModal() {
            if (!state.tripData) return;
            const currentDay = state.tripData.budget.daily[state.currentDayIndex];
            const modal = document.getElementById('edit-budget-modal');
            const dailyBudgetInput = document.getElementById('edit-daily-budget');
            const totalBudgetInput = document.getElementById('edit-total-budget');

            if (currentDay && state.tripData) {
                dailyBudgetInput.value = currentDay.budget;
                totalBudgetInput.value = state.tripData.budget.totalBudget;
                modal.classList.remove('hidden');
            }
        }

        function closeEditBudgetModal() {
            document.getElementById('edit-budget-modal').classList.add('hidden');
        }

        function saveBudget() {
            const dailyBudgetInput = document.getElementById('edit-daily-budget').value;
            const totalBudgetInput = document.getElementById('edit-total-budget').value;
            const newDailyBudget = parseFloat(dailyBudgetInput);
            const newTotalBudget = parseFloat(totalBudgetInput);

            if (isNaN(newDailyBudget) || isNaN(newTotalBudget) || newDailyBudget <= 0 || newTotalBudget <= 0) {
                // ä½¿ç”¨ç°¡å–®çš„ modal æ›¿ä»£ alert
                const messageBox = document.getElementById('message-box');
                messageBox.innerHTML = `<div class="bg-accent-red text-snow-white p-3 rounded-lg shadow-md">è«‹è¼¸å…¥æœ‰æ•ˆçš„é ç®—é‡‘é¡ã€‚</div>`;
                setTimeout(() => messageBox.innerHTML = '', 3000);
                return;
            }

            const newTripData = JSON.parse(JSON.stringify(state.tripData));
            newTripData.budget.totalBudget = newTotalBudget;
            newTripData.budget.daily[state.currentDayIndex].budget = newDailyBudget;
            
            window.saveTripData(newTripData);
            closeEditBudgetModal();
        }
        
        // Simpler Edit/Add Itinerary functionality (in-page edit)
        function toggleItineraryEditMode(event, dayIndex, eventIndex) {
            const card = event.currentTarget.closest('.itinerary-card');
            const displayElements = card.querySelectorAll('.display-mode');
            const editElements = card.querySelectorAll('.edit-mode');
            const isEditing = card.classList.contains('editing');
            
            if (isEditing) {
                // Save logic
                const newName = card.querySelector('input[name="name"]').value;
                const newNotes = card.querySelector('textarea[name="notes"]').value;

                const newTripData = JSON.parse(JSON.stringify(state.tripData));
                const eventToUpdate = newTripData.itinerary[dayIndex].events[eventIndex];
                eventToUpdate.name = newName;
                eventToUpdate.notes = newNotes;
                
                window.saveTripData(newTripData);

                card.classList.remove('editing');
                displayElements.forEach(el => el.classList.remove('hidden'));
                editElements.forEach(el => el.classList.add('hidden'));

            } else {
                // Enter edit mode
                // ç¢ºä¿å…¶ä»–å¡ç‰‡é€€å‡ºç·¨è¼¯æ¨¡å¼
                document.querySelectorAll('.itinerary-card.editing').forEach(c => {
                    c.classList.remove('editing');
                    c.querySelectorAll('.display-mode').forEach(el => el.classList.remove('hidden'));
                    c.querySelectorAll('.edit-mode').forEach(el => el.classList.add('hidden'));
                });


                card.classList.add('editing');
                displayElements.forEach(el => el.classList.add('hidden'));
                editElements.forEach(el => el.classList.remove('hidden'));
            }
        }

        // --- æ¸²æŸ“å„åˆ†é å…§å®¹ ---

        function renderItinerary() {
            if (!state.tripData) return `<div class="p-8 text-center text-accent-red">è¡Œç¨‹è³‡æ–™è¼‰å…¥éŒ¯èª¤ã€‚</div>`;

            const itinerary = state.tripData.itinerary;
            const currentDay = itinerary[state.currentDayIndex];
            const dailyBudget = state.tripData.budget.daily[state.currentDayIndex];
            
            // ç²å–å¹´ä»½
            const tripYear = state.tripData.dates.substring(0, 4);

            // æ ¼å¼åŒ– MM/DD ç‚º DD/MM/YYYY
            const fullDate = (dateMMDD) => formatDateToDisplay(dateMMDD, tripYear);


            // 1. æ¯æ—¥é¸æ“‡å™¨ (å·²ç§»è‡³å›ºå®šé ‚éƒ¨æ¬„ï¼Œåªæ¸²æŸ“æŒ‰éˆ•)
            const daySelectorButtons = itinerary.map((day, index) => `
                <button onclick="selectDay(${index})"
                    class="flex-shrink-0 px-4 py-2 mx-1 rounded-full text-sm font-bold transition-all duration-200 whitespace-nowrap
                    ${index === state.currentDayIndex ? 'bg-fuji-blue text-snow-white shadow-md' : 'bg-snow-white text-gray-700 hover:bg-fuji-blue/10'}">
                    ${day.dayName} (${fullDate(day.date)})
                </button>
            `).join('');
            
            // 2. æ¯æ—¥æ¦‚è¦½å¡ç‰‡
            const dailySummaryCard = `
                <div class="m-4 p-4 bg-snow-white shadow-lg rounded-xl card-japanese border-t-4 border-fuji-blue/50">
                    <h2 class="text-xl font-bold text-fuji-blue mb-2">${currentDay.dayName}ï¼š${currentDay.mainArea}</h2>
                    <p class="text-sm text-gray-500 mb-4">${fullDate(currentDay.date)}</p>
                    
                    <!-- æ¯æ—¥å¤©æ°£ -->
                    <div class="flex items-center space-x-2 text-md text-gray-700 mb-3">
                        <i data-lucide="sun" class="w-5 h-5 text-accent-yellow"></i>
                        <span>å³æ™‚å¤©æ°£ï¼š${currentDay.weather}</span>
                    </div>

                    <!-- æ¯æ—¥é ç®— -->
                    <div class="flex justify-between items-center text-sm font-semibold p-3 bg-warm-gray rounded-lg">
                        <span class="text-fuji-blue">é ç®—é¤˜é¡ (${dailyBudget.budget === 0 ? 'N/A' : state.tripData.budget.baseCurrency})ï¼š</span>
                        <span class="${dailyBudget.spent > dailyBudget.budget ? 'text-accent-red' : 'text-accent-green'}">
                             $${(dailyBudget.budget - dailyBudget.spent).toFixed(0)} / $${dailyBudget.budget.toFixed(0)}
                        </span>
                        <button onclick="openEditBudgetModal()" class="text-fuji-blue hover:text-accent-red transition-colors ml-2" aria-label="ç·¨è¼¯é ç®—">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `;

            // 3. è¡Œç¨‹äº‹ä»¶å¡ç‰‡åˆ—è¡¨
            const eventsList = currentDay.events.map((event, eventIndex) => {
                const categoryStyle = getCategoryStyle(event.category);
                const iconName = categoryIcons[event.category] || 'map-pin';
                const hasAddress = event.address && event.address.includes('ì„œìš¸');
                const naverMapUrl = hasAddress ? getNaverMapUrl(event.address) : '#';
                
                // æ¨¡æ“¬åœè»Šå’ŒåŠ æ²¹è³‡è¨Š (åªæœ‰äº¤é€šå’Œè³¼ç‰©/æ™¯é»æœƒé¡¯ç¤º)
                let carInfo = '';
                if (event.category === 'è³¼ç‰©' || event.category === 'æ™¯é»') {
                    carInfo = `
                        <div class="text-xs text-gray-400 mt-2 flex items-center space-x-2">
                            <i data-lucide="parking-square" class="w-3 h-3"></i><span>å»ºè­°åœè»Šå ´ï¼šæ˜æ´æ¨‚å¤©ç™¾è²¨ (Mock)</span>
                        </div>
                    `;
                } else if (event.category === 'äº¤é€š') {
                    carInfo = `
                        <div class="text-xs text-gray-400 mt-2 flex items-center space-x-2">
                            <i data-lucide="gas-station" class="w-3 h-3"></i><span>å»ºè­°åŠ æ²¹ç«™ï¼šå¼˜å¤§ Shell (Mock)</span>
                        </div>
                    `;
                }
                
                // æå– DD/MM
                const [eventMonth, eventDay] = currentDay.date.split('/');

                return `
                    <div class="itinerary-card m-4 p-4 bg-snow-white shadow-xl rounded-2xl card-japanese transition-all duration-300 transform hover:scale-[1.01] border-l-4 border-fuji-blue/50">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center">
                                <!-- UPDATED BLOCK: åŠ ä¸Šæ—¥æœŸ -->
                                <div class="flex flex-col items-start mr-3">
                                    <span class="text-2xl font-black text-fuji-blue">${event.time}</span>
                                    <span class="text-xs text-gray-500 mt-[-2px]">${eventDay}/${eventMonth}</span>
                                </div>
                                <!-- END UPDATED BLOCK -->
                                <span class="px-3 py-1 text-xs font-bold rounded-full ${categoryStyle}">
                                    <i data-lucide="${iconName}" class="w-3 h-3 inline mr-1"></i>
                                    ${event.category}
                                </span>
                            </div>
                            <!-- ç·¨è¼¯/ä¿å­˜æŒ‰éˆ• -->
                             <button onclick="toggleItineraryEditMode(event, ${state.currentDayIndex}, ${eventIndex})" 
                                class="text-fuji-blue hover:text-accent-red transition-colors edit-toggle-btn" 
                                aria-label="ç·¨è¼¯è¡Œç¨‹">
                                <i data-lucide="edit-3" class="w-5 h-5 display-mode"></i>
                                <span class="edit-mode hidden px-3 py-1 bg-accent-red text-white text-xs rounded-full shadow-md">ä¿å­˜</span>
                            </button>
                        </div>
                        
                        <!-- æ™¯é»åç¨± (é¡¯ç¤ºæ¨¡å¼) -->
                        <h3 class="text-lg font-bold text-gray-800 display-mode">${event.name}</h3>
                        <!-- æ™¯é»åç¨± (ç·¨è¼¯æ¨¡å¼) -->
                        <input type="text" name="name" value="${event.name}" class="edit-mode hidden w-full p-2 border border-fuji-blue/50 rounded-md text-lg font-bold mb-2">

                        <p class="text-sm text-gray-500 mb-3 display-mode">${event.address}</p>
                        
                        <!-- æè¿°/å‚™è¨» (é¡¯ç¤ºæ¨¡å¼) -->
                        <p class="text-base mb-3 display-mode">${event.notes}</p>
                        <!-- æè¿°/å‚™è¨» (ç·¨è¼¯æ¨¡å¼) -->
                        <textarea name="notes" class="edit-mode hidden w-full p-2 border border-fuji-blue/50 rounded-md text-sm mb-3" rows="2">${event.notes}</textarea>

                        <!-- æ¨™ç±¤ -->
                        <div class="flex flex-wrap space-x-2 mb-3">
                            ${event.tags.map(tag => `
                                <span class="px-3 py-1 text-xs font-semibold rounded-full shadow ${getTagStyle(tag)}">${tag}</span>
                            `).join('')}
                        </div>
                        
                        <!-- æ‹ç…§å°æŠ€å·§ -->
                        ${event.photoTip ? `
                            <div class="mt-3 p-3 bg-fuji-blue/10 border-l-4 border-fuji-blue rounded-r-lg">
                                <p class="text-xs font-bold text-fuji-blue mb-1">ğŸ“¸ æ‹ç…§å°æŠ€å·§</p>
                                <p class="text-sm text-gray-700">${event.photoTip}</p>
                            </div>
                        ` : ''}

                        <!-- åœè»Š/åŠ æ²¹è³‡è¨Š -->
                        ${carInfo}

                        <!-- å°èˆªèˆ‡æ—…è¨˜ -->
                        <div class="mt-4 pt-3 border-t border-warm-gray flex justify-between space-x-2">
                            <a href="${naverMapUrl}" target="_blank" class="${hasAddress ? 'bg-fuji-blue hover:bg-fuji-blue/80' : 'bg-gray-300 cursor-not-allowed'} text-snow-white text-sm py-2 px-4 rounded-full font-bold transition-colors flex items-center w-1/2 justify-center">
                                <i data-lucide="map" class="w-4 h-4 mr-2"></i> Naver Map
                            </a>
                             <button class="bg-accent-red/80 hover:bg-accent-red text-snow-white text-sm py-2 px-4 rounded-full font-bold transition-colors flex items-center w-1/2 justify-center">
                                <i data-lucide="camera" class="w-4 h-4 mr-2"></i> ä¸Šå‚³ç…§ç‰‡ (æ—…è¨˜)
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // 4. å»ºè­°ç©¿è‘—å’Œé›ªæ³
            const dressCodeCard = `
                 <div class="m-4 p-4 bg-fuji-blue/10 shadow-lg rounded-xl card-japanese border-l-4 border-accent-red">
                    <h4 class="text-md font-bold text-accent-red mb-2"><i data-lucide="shirt" class="w-4 h-4 inline mr-1"></i> å»ºè­°ç©¿è‘—èˆ‡é›ªæ³</h4>
                    <p class="text-sm text-gray-700">${currentDay.dressCode}</p>
                </div>
            `;
            
             // 5. æ–°å¢è¡Œç¨‹æŒ‰éˆ•
            const addEventButton = `
                 <div class="m-4 pt-2 pb-20 text-center">
                    <button class="bg-accent-green hover:bg-accent-green/90 text-snow-white text-md py-3 px-6 rounded-full font-bold shadow-lg transition-transform transform hover:scale-105" onclick="alert('æ–°å¢è¡Œç¨‹åŠŸèƒ½å¾…å¯¦ç¾ï¼')">
                        <i data-lucide="plus-circle" class="w-5 h-5 inline mr-2"></i> æ–°å¢ä»Šæ—¥è¡Œç¨‹
                    </button>
                </div>
            `;


            return { daySelectorButtons, content: dailySummaryCard + dressCodeCard + eventsList + addEventButton };
        }

        function renderGuide() {
            if (!state.tripData) return `<div class="p-8 text-center text-accent-red">æŒ‡å—è³‡æ–™è¼‰å…¥éŒ¯èª¤ã€‚</div>`;

            const f = state.tripData.flights;

            // 1. èˆªç­ç‹€æ³å¡ç‰‡
            const flightCard = (type, data) => `
                <div class="p-4 rounded-xl bg-snow-white shadow-lg mb-4 border-l-4 ${type === 'outbound' ? 'border-accent-red' : 'border-fuji-blue'}">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-bold text-gray-700">${type === 'outbound' ? 'å»ç¨‹' : 'å›ç¨‹'}ï¼š${data.flight}</h3>
                        <span class="px-3 py-1 text-xs font-bold rounded-full ${data.status === 'æº–æ™‚' ? 'bg-accent-green text-white' : 'bg-accent-red text-white'}">
                            ${data.status}
                        </span>
                    </div>
                    <p class="text-sm text-gray-500 mb-2">
                        <i data-lucide="plane-takeoff" class="w-4 h-4 inline mr-1 text-fuji-blue"></i> 
                        ${data.departure} - ${data.from} â†’ ${data.arrival} - ${data.to}
                    </p>
                    <button class="text-xs text-fuji-blue hover:underline mt-1" onclick="alert('èˆªç­ç‹€æ…‹å¯¦æ™‚æŸ¥è©¢åŠŸèƒ½å¾…é€£æ¥èˆªç©ºå…¬å¸ API')">
                        <i data-lucide="refresh-cw" class="w-3 h-3 inline mr-1"></i> æŸ¥è©¢æœ€æ–°ç‹€æ…‹
                    </button>
                </div>
            `;

            // 2. å³æ™‚åŒ¯ç‡å¡ç‰‡
            const exchangeRateCard = `
                <div class="p-4 rounded-xl bg-snow-white shadow-lg mb-4 border-t-4 border-accent-yellow">
                    <h3 class="text-lg font-bold text-gray-700 mb-2 flex items-center"><i data-lucide="dollar-sign" class="w-5 h-5 mr-2 text-accent-yellow"></i> å³æ™‚å°æ›ç‡</h3>
                    <div class="text-3xl font-extrabold text-fuji-blue">
                        1 ${state.tripData.budget.baseCurrency} = ${state.exchangeRate.rate === 0.0 ? state.exchangeRate.source : state.exchangeRate.rate.toFixed(2)} ${state.tripData.budget.targetCurrency}
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        è³‡æ–™ä¾†æº: ${state.exchangeRate.source}
                        <button class="text-fuji-blue/70 hover:underline ml-2" onclick="fetchExchangeRate()" aria-label="é‡æ–°æ•´ç†åŒ¯ç‡">
                            <i data-lucide="rotate-cw" class="w-3 h-3 inline"></i>
                        </button>
                    </p>
                </div>
            `;

            // 3. æ—…éŠç¸½è¦½ (åœ°åœ–é€£çµ)
            const mapLinkCard = `
                <div class="p-4 rounded-xl bg-snow-white shadow-lg mb-4 border-r-4 border-accent-green">
                    <h3 class="text-lg font-bold text-gray-700 mb-2 flex items-center"><i data-lucide="map-pin" class="w-5 h-5 mr-2 text-accent-green"></i> éŸ“åœ‹é¦–çˆ¾åœ°åœ–</h3>
                    <p class="text-sm text-gray-500 mb-3">ä½¿ç”¨ Naver Map ç€è¦½æ‰€æœ‰è¡Œç¨‹åœ°é»ã€‚</p>
                    <a href="https://map.naver.com/" target="_blank" class="bg-accent-green hover:bg-accent-green/80 text-snow-white text-md py-2 px-4 rounded-full font-bold transition-colors flex items-center justify-center">
                        <i data-lucide="navigation" class="w-4 h-4 mr-2"></i> æ‰“é–‹ Naver Map ç¸½è¦½
                    </a>
                </div>
            `;
            
             const userIdCard = `
                <div class="p-4 rounded-xl bg-snow-white shadow-lg mb-4 border-b-4 border-warm-gray">
                    <h3 class="text-sm font-bold text-gray-700 mb-2 flex items-center"><i data-lucide="user" class="w-4 h-4 mr-2 text-fuji-blue"></i> ç”¨æˆ¶ ID (åˆ†äº«/é™¤éŒ¯ç”¨)</h3>
                    <p class="text-xs break-words text-gray-500">${window.userId || 'æœªç™»å…¥/è¼‰å…¥ä¸­...'}</p>
                </div>
            `;


            return `
                <div class="p-4 pb-20">
                    <h2 class="text-xl font-bold text-fuji-blue mb-4">æ—…è¡ŒæŒ‡å—èˆ‡è³‡è¨Š</h2>
                    ${flightCard('outbound', f.outbound)}
                    ${flightCard('inbound', f.inbound)}
                    ${exchangeRateCard}
                    ${mapLinkCard}
                    ${userIdCard}
                </div>
            `;
        }
        
        function renderBudget() {
             if (!state.tripData) return `<div class="p-8 text-center text-accent-red">é ç®—è³‡æ–™è¼‰å…¥éŒ¯èª¤ã€‚</div>`;

            const budgetData = state.tripData.budget;
            const dailyData = budgetData.daily;
            const totalSpent = dailyData.reduce((acc, day) => acc + day.spent, 0);
            const remaining = budgetData.totalBudget - totalSpent;
            const currency = budgetData.baseCurrency;

            // ç¸½é ç®—å¡ç‰‡
            const totalCard = `
                <div class="m-4 p-6 bg-fuji-blue shadow-xl rounded-2xl text-snow-white card-japanese">
                    <p class="text-sm opacity-80">ç¸½æ—…è¡Œé ç®— (ç¸½æ”¯å‡º)</p>
                    <h3 class="text-4xl font-extrabold mb-1">$${remaining.toFixed(0)}</h3>
                    <p class="text-sm">é¤˜é¡ / ç¸½é ç®—ï¼š$${totalSpent.toFixed(0)} / $${budgetData.totalBudget.toFixed(0)} ${currency}</p>
                    <div class="w-full bg-fuji-blue/50 rounded-full h-2.5 mt-2">
                        <div class="h-2.5 rounded-full ${remaining < 0 ? 'bg-accent-red' : 'bg-accent-green'}" 
                             style="width: ${(totalSpent / budgetData.totalBudget * 100).toFixed(1)}%">
                        </div>
                    </div>
                </div>
            `;

            // æ¯æ—¥æ¶ˆè²»ç´€éŒ„
            const dailyList = `
                <div class="m-4 mt-6">
                    <h2 class="text-xl font-bold text-gray-700 mb-3">æ¯æ—¥æ¶ˆè²»æ¦‚è¦½</h2>
                    ${dailyData.map((day, index) => {
                        const dailyRemaining = day.budget - day.spent;
                        // ç²å–å¹´ä»½
                        const tripYear = state.tripData.dates.substring(0, 4);
                        const [month, dayNum] = day.date.split('/');
                        const formattedDate = formatDateToDisplay(day.date, tripYear); // DD/MM/YYYY
                        
                        return `
                             <div class="flex justify-between items-center p-4 mb-3 bg-snow-white shadow-md rounded-xl border-l-4 ${dailyRemaining < 0 ? 'border-accent-red' : 'border-accent-green'}">
                                <div class="flex-1">
                                    <h4 class="font-bold text-gray-800">${formattedDate} (${state.tripData.itinerary[index].dayName})</h4>
                                    <p class="text-xs text-gray-500">é ç®—: $${day.budget.toFixed(0)} ${currency}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-lg font-extrabold ${dailyRemaining < 0 ? 'text-accent-red' : 'text-accent-green'}">$${dailyRemaining.toFixed(0)}</p>
                                    <p class="text-xs text-gray-500">å·²èŠ±è²»: $${day.spent.toFixed(0)} ${currency}</p>
                                </div>
                                <button onclick="selectDay(${index}); switchTab('itinerary');" class="ml-4 text-fuji-blue hover:text-accent-red transition-colors" aria-label="æŸ¥çœ‹è¡Œç¨‹">
                                    <i data-lucide="eye" class="w-5 h-5"></i>
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            // æ–°å¢æ¶ˆè²»æŒ‰éˆ•
             const addExpenseButton = `
                 <div class="m-4 pt-2 pb-20 text-center">
                    <button class="bg-fuji-blue hover:bg-fuji-blue/90 text-snow-white text-md py-3 px-6 rounded-full font-bold shadow-lg transition-transform transform hover:scale-105" onclick="alert('æ–°å¢æ¶ˆè²»ç´€éŒ„åŠŸèƒ½å¾…å¯¦ç¾ï¼')">
                        <i data-lucide="wallet" class="w-5 h-5 inline mr-2"></i> æ–°å¢æ¶ˆè²»ç´€éŒ„
                    </button>
                </div>
            `;


            return totalCard + dailyList + addExpenseButton;
        }


        function renderApp() {
            const appContent = document.getElementById('app-content');
            const header = document.getElementById('app-header');
            const dayBar = document.getElementById('day-bar');

            // æ¸²æŸ“ Header
            if (state.tripData) {
                header.innerHTML = `
                    <div class="flex flex-col text-center pt-2 pb-1">
                        <h1 class="text-xl font-bold text-fuji-blue">${state.tripData.tripName}</h1>
                        <p class="text-xs text-gray-500">${state.tripData.dates}</p>
                    </div>
                `;
            } else {
                 // Fallback header
                 header.innerHTML = `
                    <div class="flex flex-col text-center pt-2 pb-1">
                        <h1 class="text-xl font-bold text-fuji-blue">é¦–çˆ¾è–èª•æ—…è¡Œ (éŒ¯èª¤)</h1>
                        <p class="text-xs text-accent-red">æ•¸æ“šè¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚</p>
                    </div>
                `;
            }
            
            // æ¸²æŸ“ Day Bar
            if (state.currentTab === 'itinerary' && state.tripData) {
                const { daySelectorButtons } = renderItinerary();
                dayBar.classList.remove('hidden');
                document.getElementById('day-selector-buttons').innerHTML = daySelectorButtons;
                
                // *** æ»¾å‹•åˆ°ç•¶å‰é¸ä¸­çš„ Dayï¼Œæ”¹å–„ä½¿ç”¨è€…é«”é©— ***
                const currentDayButton = document.querySelector('.bg-fuji-blue.text-snow-white');
                if (currentDayButton) {
                    currentDayButton.parentElement.scrollTo({
                        left: currentDayButton.offsetLeft - (currentDayButton.parentElement.offsetWidth / 2) + (currentDayButton.offsetWidth / 2),
                        behavior: 'smooth'
                    });
                }
                // *** END æ»¾å‹•å„ªåŒ– ***


            } else {
                dayBar.classList.add('hidden');
            }


            // æ¸²æŸ“ä¸»å…§å®¹å€
            let content = '';
            switch (state.currentTab) {
                case 'itinerary':
                    // åªæœ‰ content éƒ¨åˆ†
                    content = renderItinerary().content; 
                    break;
                case 'guide':
                    content = renderGuide();
                    break;
                case 'budget':
                    content = renderBudget();
                    break;
            }
            appContent.innerHTML = content;
            
            // é‡æ–°æ¸²æŸ“ Lucide icons
            lucide.createIcons();

            // æ›´æ–°å°è¦½åˆ—ç‹€æ…‹
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const tab = btn.getAttribute('data-tab');
                if (tab === state.currentTab) {
                    // å¯¦è‰²/é«˜äº®ç‹€æ…‹
                    btn.classList.add('text-fuji-blue', 'font-bold', 'bg-snow-white', 'shadow-2xl', 'scale-105');
                    btn.classList.remove('text-warm-gray', 'hover:text-snow-white/80', 'opacity-70');
                } else {
                    // åº•éƒ¨å°è¦½æ¢çš„åº•è‰²æ˜¯ fuji-blue
                    btn.classList.remove('text-fuji-blue', 'font-bold', 'bg-snow-white', 'shadow-2xl', 'scale-105');
                    btn.classList.add('text-warm-gray', 'hover:text-snow-white/80', 'opacity-70');
                }
            });
        }

        window.onload = () => {
             // 1. ç«‹å³æ¸²æŸ“é è¨­æ•¸æ“š (state.tripData åœ¨å…¨åŸŸå·²è¨­å®š)
             renderApp();
             
             // 2. Firebase åˆå§‹åŒ– (åœ¨ module script ä¸­è‡ªå‹•é–‹å§‹)
        };

        // å°‡é‡è¦å‡½æ•¸æš´éœ²çµ¦å…¨åŸŸä»¥ä¾› HTML å…§è¯äº‹ä»¶ä½¿ç”¨
        window.switchTab = switchTab;
        window.selectDay = selectDay;
        window.openEditBudgetModal = openEditBudgetModal;
        window.closeEditBudgetModal = closeEditBudgetModal;
        window.saveBudget = saveBudget;
        window.toggleItineraryEditMode = toggleItineraryEditMode;
        window.fetchExchangeRate = fetchExchangeRate;
    </script>

    <style>
        /* æ—¥ç³»å¯æ„›é¢¨æ ¼èƒŒæ™¯ */
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #f5f5f5; /* warm-gray */
            background-image: radial-gradient(circle at 100% 150%, transparent 24%, #6a82b31a 25%, #6a82b31a 26%, transparent 27%, transparent 74%, #6a82b31a 75%, #6a82b31a 76%, transparent 77%, transparent), radial-gradient(circle at 0% 150%, transparent 24%, #6a82b31a 25%, #6a82b31a 26%, transparent 27%, transparent 74%, #6a82b31a 75%, #6a82b31a 76%, transparent 77%, transparent), radial-gradient(circle at 50% 100%, #6a82b31a 10%, #f5f5f5 11%);
            background-size: 50px 100px;
            background-position: 0 0, 50px 0, 0 0;
            padding-bottom: 70px; /* åº•éƒ¨å°è¦½åˆ—é«˜åº¦ */
        }
        /* æ—¥å¼åœ“è§’å¡ç‰‡æ¨£å¼ */
        .card-japanese {
            border-radius: 18px; /* æ›´å¤§çš„åœ“è§’ */
        }
        /* Main Content é ‚éƒ¨ç©ºé–“èª¿æ•´ï¼šHeader (56px) + Day Bar (~48px) */
        .content-container {
            min-height: 100vh;
        }
        /* å½ˆå‡ºè¦–çª—å‹•ç•« */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        /* éš±è—æ»¾å‹•æ¢ä½†ä¿æŒæ»¾å‹•åŠŸèƒ½ (åƒ…é™ Webkit ç€è¦½å™¨ï¼Œå¦‚ Chrome/Safari) */
        #day-selector-buttons::-webkit-scrollbar {
            display: none;
        }
        #day-selector-buttons {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>

<body class="min-h-screen">
    <!-- Header (å›ºå®šé ‚éƒ¨ - Z-20) -->
    <header id="app-header" class="fixed top-0 left-0 w-full bg-snow-white/95 backdrop-blur-sm z-20 shadow-md">
        <div class="max-w-md mx-auto">
            <!-- Header å…§å®¹æœƒåœ¨ JS ä¸­è¨­å®š -->
            <div class="flex flex-col text-center pt-2 pb-1">
                <h1 class="text-xl font-bold text-fuji-blue">é¦–çˆ¾è–èª•æ—…è¡Œ</h1>
                <p class="text-xs text-gray-500">2025/12/25 - 2025/12/29</p>
            </div>
        </div>
    </header>

    <!-- Day Selector Bar (å›ºå®šåœ¨ Header ä¸‹æ–¹ - Z-15) -->
    <div id="day-bar" class="fixed top-[56px] left-0 right-0 max-w-md mx-auto z-10 bg-warm-gray/90 backdrop-blur-sm shadow-md">
        <div class="flex items-center p-2">
            <!-- Day Selector Buttons (Scrollable) -->
            <!-- FIX: ä½¿ç”¨ flex-1 min-w-0 ç¢ºä¿å®ƒåœ¨ flex å®¹å™¨ä¸­å¯ä»¥æ­£ç¢ºæ»¾å‹•ä¸”ä½”ç”¨å…¨éƒ¨å‰©é¤˜ç©ºé–“ -->
            <div id="day-selector-buttons" class="flex overflow-x-auto flex-1 min-w-0 pb-1">
                <!-- Buttons rendered here by JS -->
            </div>
            
            <!-- æ–°å¢æ—¥å­æŒ‰éˆ• (Fixed width) -->
            <button onclick="addDay()" class="flex-shrink-0 ml-2 px-3 py-2 text-sm font-bold rounded-full bg-accent-green text-snow-white shadow-md transition-transform hover:scale-105 whitespace-nowrap">
                <i data-lucide="calendar-plus" class="w-4 h-4 inline mr-1"></i>
                æ–°å¢æ—¥
            </button>
        </div>
    </div>


    <!-- Message Box (ç”¨æ–¼å–ä»£ alert) -->
    <div id="message-box" class="fixed top-16 left-0 right-0 z-40 p-4 max-w-sm mx-auto"></div>

    <!-- Main Content Area (èª¿æ•´ pt-24 ä»¥é¿é–‹å›ºå®šçš„ Header + Day Bar) -->
    <main id="app-content" class="max-w-md mx-auto pt-24"></main>

    <!-- Bottom Floating Navigation (å¯¦è‰²/å›ºåº• - Z-20) -->
    <nav class="fixed bottom-0 left-0 w-full bg-fuji-blue shadow-2xl z-20">
        <div class="max-w-md mx-auto flex justify-around p-2">
            <!-- é è¨­ 'itinerary' å•Ÿç”¨ -->
            <button data-tab="itinerary" onclick="switchTab('itinerary')" class="tab-btn flex flex-col items-center p-2 rounded-full transition-all duration-300">
                <i data-lucide="calendar-check" class="w-6 h-6"></i>
                <span class="text-xs">è¡Œç¨‹</span>
            </button>
            <button data-tab="guide" onclick="switchTab('guide')" class="tab-btn flex flex-col items-center p-2 rounded-full transition-all duration-300">
                <i data-lucide="book-open-text" class="w-6 h-6"></i>
                <span class="text-xs">æŒ‡å—</span>
            </button>
            <button data-tab="budget" onclick="switchTab('budget')" class="tab-btn flex flex-col items-center p-2 rounded-full transition-all duration-300">
                <i data-lucide="wallet" class="w-6 h-6"></i>
                <span class="text-xs">æ¶ˆè²»</span>
            </button>
        </div>
    </nav>
    
    <!-- é ç®—ç·¨è¼¯ Modal -->
    <div id="edit-budget-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 z-30 flex items-center justify-center hidden">
        <div class="bg-snow-white p-6 rounded-2xl shadow-2xl w-11/12 max-w-sm transform scale-100 transition-transform card-japanese">
            <h3 class="text-xl font-bold text-fuji-blue mb-4">ç·¨è¼¯é ç®—</h3>
            
            <div class="mb-4">
                <label for="edit-total-budget" class="block text-sm font-medium text-gray-700 mb-1">ç¸½é ç®— (HKD)</label>
                <input type="number" id="edit-total-budget" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-fuji-blue focus:border-fuji-blue transition" min="100" />
            </div>
            
            <div class="mb-6">
                <label for="edit-daily-budget" class="block text-sm font-medium text-gray-700 mb-1">ç•¶æ—¥é ç®— (HKD)</label>
                <input type="number" id="edit-daily-budget" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-fuji-blue focus:border-fuji-blue transition" min="100" />
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="closeEditBudgetModal()" class="px-4 py-2 text-gray-600 bg-warm-gray rounded-full font-semibold hover:bg-gray-200 transition">
                    å–æ¶ˆ
                </button>
                <button onclick="saveBudget()" class="px-4 py-2 text-snow-white bg-fuji-blue rounded-full font-semibold hover:bg-fuji-blue/80 transition">
                    å„²å­˜è®Šæ›´
                </button>
            </div>
        </div>
    </div>

</body>
</html>

